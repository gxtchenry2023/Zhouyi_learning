
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>周易64卦 · 选择题（超兼容版）</title>
  <style>
    :root{--bg:#0f1115;--panel:#161a22;--muted:#8b93a7;--text:#eef2ff;--accent:#6aa1ff;--right:#2ecc71;--wrong:#ff5c5c;--btn:#20283a;--btn-border:#2b3550}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;background:#0f1115;color:var(--text)}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    .card{background:var(--panel);border:1px solid #202533;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:24px}
    p.desc{margin:0 0 18px;color:var(--muted);font-size:14px}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:14px 0 18px}
    @media (max-width:720px){.controls{grid-template-columns:1fr}}
    select,button{width:100%;padding:12px 14px;border-radius:12px;background:var(--btn);color:var(--text);border:1px solid var(--btn-border);font-size:15px;-webkit-tap-highlight-color:transparent}
    button.primary{background:var(--accent);color:#0b1020;border:0;font-weight:600;cursor:pointer}
    .qbox{padding:16px;border:1px dashed #2b3550;border-radius:12px;margin:10px 0 16px;background:#121722}
    .prompt{font-size:18px;line-height:1.6}
    .options{display:grid;gap:10px;margin:12px 0}
    .opt{padding:12px 14px;border-radius:12px;background:var(--btn);border:1px solid var(--btn-border);text-align:left}
    .opt.correct{border-color:var(--right);background:rgba(46,204,113,.1)}
    .opt.incorrect{border-color:var(--wrong);background:rgba(255,92,92,.08)}
    .progress{height:8px;background:#1b2130;border-radius:999px;overflow:hidden;margin:8px 0 16px;border:1px solid #28314a}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#6aa1ff,#8b9dff)}
    .stats{display:flex;gap:12px;color:var(--muted);font-size:14px;flex-wrap:wrap}
    .pill{padding:2px 8px;border:1px solid #2b3550;border-radius:999px}
    .result{display:none;margin-top:14px;padding:14px;border-radius:12px;background:#121722;border:1px solid #28314a}
    .footer{margin-top:18px;display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>周易 64 卦 · 选择题（超兼容版）</h1>
      <p class="desc">如果“开始测验”无反应，确认是用 Safari 打开的（不是文件预览）。如仍不行，点下面“强制启动”。</p>
      <div class="controls">
        <select id="mode">
          <option value="name2pair">模式A：卦名 → 选上/下卦</option>
          <option value="pair2name">模式B：上/下卦 → 选卦名</option>
          <option value="mixed">模式C：混合</option>
        </select>
        <select id="count">
          <option>10</option><option>15</option><option>20</option><option>32</option><option selected>64</option>
        </select>
        <button id="start" class="primary" type="button" onclick="window._forceStart && window._forceStart()">开始测验</button>
      </div>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="stats">
        <div class="pill">进度：<span id="prog">0/0</span></div>
        <div class="pill">得分：<span id="score">0</span></div>
        <div class="pill">正确率：<span id="acc">0%</span></div>
      </div>

      <div id="qbox" class="qbox" style="display:none">
        <div id="prompt" class="prompt"></div>
        <div id="options" class="options"></div>
        <div id="feedback" class="hint"></div>
      </div>

      <div id="result" class="result">
        <h3>本轮完成 ✅</h3>
        <div id="summary" class="hint"></div>
        <ol id="missed" class="hint"></ol>
        <div class="footer">
          <button id="retryWrong" type="button">仅重做错题</button>
          <button id="restart" class="primary" type="button">重新开始</button>
        </div>
      </div>
    </div>
  </div>

<script>
// 将核心逻辑挂到 window，按钮也有 inline onclick 作为兜底，避免事件绑定失败
(function(){
  var HEXA=[
    {name:"乾",up:"天",down:"天"},{name:"坤",up:"地",down:"地"},
    {name:"屯",up:"水",down:"雷"},{name:"蒙",up:"山",down:"水"},
    {name:"需",up:"水",down:"天"},{name:"讼",up:"天",down:"水"},
    {name:"师",up:"地",down:"水"},{name:"比",up:"水",down:"地"},
    {name:"小畜",up:"风",down:"天"},{name:"履",up:"天",down:"泽"},
    {name:"泰",up:"地",down:"天"},{name:"否",up:"天",down:"地"},
    {name:"同人",up:"天",down:"火"},{name:"大有",up:"火",down:"天"},
    {name:"谦",up:"地",down:"山"},{name:"豫",up:"雷",down:"地"},
    {name:"随",up:"泽",down:"雷"},{name:"蛊",up:"山",down:"风"},
    {name:"临",up:"地",down:"泽"},{name:"观",up:"风",down:"地"},
    {name:"噬嗑",up:"火",down:"雷"},{name:"贲",up:"山",down:"火"},
    {name:"剥",up:"山",down:"地"},{name:"复",up:"地",down:"雷"},
    {name:"无妄",up:"天",down:"雷"},{name:"大畜",up:"山",down:"天"},
    {name:"颐",up:"山",down:"雷"},{name:"大过",up:"泽",down:"风"},
    {name:"坎",up:"水",down:"水"},{name:"离",up:"火",down:"火"},
    {name:"咸",up:"泽",down:"山"},{name:"恒",up:"雷",down:"风"},
    {name:"遯",up:"天",down:"山"},{name:"大壮",up:"雷",down:"天"},
    {name:"晋",up:"火",down:"地"},{name:"明夷",up:"地",down:"火"},
    {name:"家人",up:"风",down:"火"},{name:"睽",up:"火",down:"泽"},
    {name:"蹇",up:"水",down:"山"},{name:"解",up:"雷",down:"水"},
    {name:"损",up:"山",down:"泽"},{name:"益",up:"风",down:"雷"},
    {name:"夬",up:"泽",down:"天"},{name:"姤",up:"天",down:"风"},
    {name:"萃",up:"泽",down:"地"},{name:"升",up:"地",down:"风"},
    {name:"困",up:"泽",down:"水"},{name:"井",up:"水",down:"风"},
    {name:"革",up:"泽",down:"火"},{name:"鼎",up:"火",down:"风"},
    {name:"震",up:"雷",down:"雷"},{name:"艮",up:"山",down:"山"},
    {name:"渐",up:"风",down:"山"},{name:"归妹",up:"雷",down:"泽"},
    {name:"丰",up:"雷",down:"火"},{name:"旅",up:"火",down:"山"},
    {name:"巽",up:"风",down:"风"},{name:"兑",up:"泽",down:"泽"},
    {name:"涣",up:"风",down:"水"},{name:"节",up:"水",down:"泽"},
    {name:"中孚",up:"风",down:"泽"},{name:"小过",up:"雷",down:"山"},
    {name:"既济",up:"水",down:"火"},{name:"未济",up:"火",down:"水"}
  ];
  function $(id){return document.getElementById(id)}
  var els={
    mode:$('mode'),count:$('count'),start:$('start'),
    qbox:$('qbox'),prompt:$('prompt'),options:$('options'),
    feedback:$('feedback'),result:$('result'),summary:$('summary'),
    missed:$('missed'),prog:$('prog'),bar:$('bar'),
    score:$('score'),acc:$('acc'),restart:$('restart'),
    retryWrong:$('retryWrong')
  };
  function randInt(n){return Math.floor(Math.random()*n)}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  var questions=[],idx=0,score=0,wrong=[],wrongBackup=[];
  function genQuestions(mode,count){
    var pool=shuffle(HEXA.slice()).slice(0,count);
    return pool.map(function(item){
      var m= mode==="mixed" ? (Math.random()<0.5?"name2pair":"pair2name") : mode;
      if(m==="name2pair"){
        var correct="上卦："+item.up+"，下卦："+item.down;
        var ds=new Set();
        while(ds.size<3){
          var a=HEXA[randInt(HEXA.length)], b=HEXA[randInt(HEXA.length)];
          var opt="上卦："+a.up+"，下卦："+b.down;
          if(opt!==correct) ds.add(opt);
        }
        var options=shuffle([correct].concat(Array.from(ds)));
        return {mode:m,prompt:"卦名："+item.name+" → 请选择其上/下卦",item:item,options:options,answer:correct};
      }else{
        var correct2=item.name;
        var names=new Set();
        while(names.size<3){
          var other=HEXA[randInt(HEXA.length)].name;
          if(other!==correct2) names.add(other);
        }
        var options2=shuffle([correct2].concat(Array.from(names)));
        return {mode:m,prompt:"上卦："+item.up+"，下卦："+item.down+" → 请选择卦名",item:item,options:options2,answer:correct2};
      }
    });
  }
  function updateHUD(){
    els.prog.textContent = Math.min(idx,questions.length)+"/"+questions.length;
    els.score.textContent = String(score);
    var acc = questions.length ? Math.round(100*score/Math.max(1,idx)) : 0;
    els.acc.textContent = (isNaN(acc)?0:acc)+"%";
    els.bar.style.width = (questions.length?(100*idx/questions.length):0) + "%";
  }
  function clearNode(node){while(node.firstChild) node.removeChild(node.firstChild)}
  function explanation(q){
    return q.mode==='name2pair' ? (q.item.name+" = 上卦「"+q.item.up+"」/ 下卦「"+q.item.down+"」")
                                : ("上卦「"+q.item.up+"」/ 下卦「"+q.item.down+"」 = 「"+q.item.name+"」")
  }
  function renderQuestion(){
    els.result.style.display='none';
    els.qbox.style.display='block';
    clearNode(els.options);
    els.feedback.textContent='';
    var q=questions[idx];
    els.prompt.textContent=q.prompt;
    q.options.forEach(function(text){
      var btn=document.createElement('button');
      btn.type='button';
      btn.className='opt';
      btn.textContent=text;
      btn.onclick=function(){
        Array.from(document.querySelectorAll('.opt')).forEach(function(b){b.disabled=true});
        if(text===q.answer){ btn.classList.add('correct'); els.feedback.textContent=explanation(q); score++; }
        else{
          btn.classList.add('incorrect');
          Array.from(document.querySelectorAll('.opt')).forEach(function(b){ if(b.textContent===q.answer) b.classList.add('correct') });
          els.feedback.textContent='再记一遍：'+explanation(q);
          wrong.push(q);
        }
        idx++; updateHUD();
        setTimeout(nextStep, 600);
      };
      els.options.appendChild(btn);
    });
    updateHUD();
  }
  function nextStep(){ if(idx>=questions.length) showResult(); else renderQuestion(); }
  function showResult(){
    els.qbox.style.display='none'; els.result.style.display='block';
    var acc = Math.round(100*score/questions.length);
    els.summary.innerHTML = "本轮共 "+questions.length+" 题，得分 <b>"+score+"</b>，正确率 <b>"+acc+"%</b>。";
    clearNode(els.missed);
    if(!wrong.length){ var li=document.createElement('li'); li.textContent='没有错题，太棒了！'; els.missed.appendChild(li); }
    else{
      var seen=new Set();
      wrong.forEach(function(q){
        var key=q.item.name+'|'+q.item.up+'|'+q.item.down+'|'+q.mode;
        if(seen.has(key)) return; seen.add(key);
        var li=document.createElement('li');
        li.textContent = (q.mode==='name2pair') ? (q.item.name+" → 上卦「"+q.item.up+"」/ 下卦「"+q.item.down+"」")
                                                : ("上卦「"+q.item.up+"」/ 下卦「"+q.item.down+"」 → 「"+q.item.name+"」");
        els.missed.appendChild(li);
      });
    }
    wrongBackup = wrong.slice();
  }
  function startQuiz(fromWrong){
    var mode=els.mode.value, count=parseInt(els.count.value,10)||10;
    idx=0; score=0; wrong=[];
    if(fromWrong && wrongBackup.length){
      questions = shuffle(wrongBackup).map(function(q){
        if(q.mode==='name2pair'){
          var correct="上卦："+q.item.up+"，下卦："+q.item.down;
          var ds=new Set();
          while(ds.size<3){
            var a=HEXA[randInt(HEXA.length)], b=HEXA[randInt(HEXA.length)];
            var opt="上卦："+a.up+"，下卦："+b.down;
            if(opt!==correct) ds.add(opt);
          }
          q.options = shuffle([correct].concat(Array.from(ds)));
        }else{
          var correct2=q.item.name;
          var names=new Set();
          while(names.size<3){
            var other=HEXA[randInt(HEXA.length)].name;
            if(other!==correct2) names.add(other);
          }
          q.options = shuffle([correct2].concat(Array.from(names)));
        }
        return q;
      });
    }else{
      questions = genQuestions(mode, count);
    }
    els.result.style.display='none';
    renderQuestion();
  }
  // 暴露兜底启动函数（按钮 inline onclick 会调用这里）
  window._forceStart = function(){
    try{ startQuiz(false); }catch(e){
      alert('启动失败：'+e.message+'\n请确认用 Safari 打开，而不是“文件预览”。');
    }
  };
  // 正常事件绑定
  if(els.start) els.start.addEventListener('click', function(){ window._forceStart(); });
  if(els.restart) els.restart.addEventListener('click', function(){ window._forceStart(); });
  if(els.retryWrong) els.retryWrong.addEventListener('click', function(){
    if(!wrongBackup.length){ alert('本轮没有错题，先做一轮完整测验吧。'); return; }
    startQuiz(true);
  });
})(); 
</script>
</body>
</html>
